<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Project Albert (Twitch API)</title>

<style>

img {
width: 210px;
height: 80px;
}

</style>

<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="twitch.min.js"></script>

<script>

var myToken = '';
var userName = '';
var comLength = 60;
var comTimeInt = 0;

$(function() {

  Twitch.init({clientId: '2zm8olne4iyx9zt9ro40h7vxool7910'}, function(error, status) {
if (status.authenticated) {
            // Already logged in, change button and store token
            //myToken = Twitch._config.session.token;
            //$('.twitch-connect').html('<button>Request new Token</button>');
        }
  });
$('.twitch-connect').click(function() {
  Twitch.login({redirect_uri: 'http://bizkit047.github.io/project_albert/', popup: false,
    scope: ['user_read', 'channel_read', 'channel_editor', 'channel_subscriptions', 'user_subscriptions', 'channel_check_subscription', 'channel_commercial']
  });
});

        $('.comm').click(function() {
 		userName = document.getElementById("twitchname").value;
		comLength = document.getElementById("comlen").value;
		myToken = document.getElementById("token").value;

                $.ajax({
                        url: 'https://api.twitch.tv/kraken/channels/' + userName + '/commercial',
                        contentType: 'application/json',
                        dataType: 'jsonp',
                        data: {
                                oauth_token: myToken, '_method': 'POST', 'length': comLength
                        },
                        headers: {'Authorization': 'OAuth ' + myToken
                        },
                        success: function (response) {
                                var newObj = response;
                                if (response === undefined)
                                {
                                	 document.getElementById("status").innerHTML = "Commercial Ran!";
                                }
                                else
                                {
                                   document.getElementById("status").innerHTML = newObj.error + ': ' + newObj.message;
                                }
                                
				comTimeInt = 0;
				clearInterval(theTimer);
				theTimer = setInterval(function(){updateComTime()}, 1000)
                                console.log(response);
                        },
                        failure: function (response) {
                                console.log(response);
                        }
                });
        });

$('.get-status').click(function(){
 		userName = document.getElementById("twitchname").value;
		myToken = document.getElementById("token").value;
  $.ajax({ url: 'https://api.twitch.tv/kraken/channels/' + userName + '/subscriptions?oauth_token=' + myToken,
            type: 'GET',
            contentType: 'application/json',
            dataType: 'jsonp',
            data: {
                    'limit': 100
                  },
            success: function(data) {
                      var newObj = data;
		      document.getElementById("status").innerHTML = newObj._total;
                     }
        })

                                 });

    });
</script>

<script>
var theTimer = setInterval(function(){updateComTime()}, 1000)

window.onload = function(){
    document.getElementById("url").innerHTML = window.location.toString();
}

function updateComTime(){
comTimeInt = comTimeInt + 1;
document.getElementById("comtime").innerHTML = "Last Commerical ran " + comTimeInt + " seconds ago!";
}

clearInterval(theTimer);

</script>

</head>

<body>

<div class="how"><h1>HOW TO USE</h1>
<p>#1. Click on "Login/Auth" to authenticate your account with Project Albert.</p>
<p>#2. After authing, the "Current URL" should give you an Access Token. Copy and paste all the numbers/letters after the "access_token=" into the "Auth Token" textbox.</p>
<p>#3. Type in your Twitch username (safe to user lowercase) and commercial length (in seconds).</p>
<p>#4. Click "Commercial" to run a commercial. If there are any errors, it will be displayed at the bottom of the page. </p>
<p>NOTE: Sub List may not be fully functional yet!</p>
<p>NOTE: You can reuse the same Auth Token</p>
<p>NOTE: I'll update this eventually to auto grab the token for you!</p></div>

<img src="http://i.imgur.com/NhGiNlQ.png" class="twitch-connect" onmouseover="this.src='http://i.imgur.com/BXERvTl.png'" onmouseout="this.src='http://i.imgur.com/NhGiNlQ.png'"/> The button on the left can be used to grab another Auth Token!
<br />
<br />
<img src="http://i.imgur.com/PITEGeL.png" class = "get-status" href="#"  onmouseover="this.src='http://i.imgur.com/jCREqQp.png'" onmouseout="this.src='http://i.imgur.com/PITEGeL.png'"/>
<br />
<br />

<p id="comtime">Last Commerical ran 0 seconds ago!</p>
<img src="http://i.imgur.com/PbZGlGW.png" class="comm" href="#"  onmouseover="this.src='http://i.imgur.com/Jqoy0AK.png'" onmouseout="this.src='http://i.imgur.com/PbZGlGW.png'"/> Make sure you fill out the text boxes below before clicking this!
<br /><br />

Twitch User Name (to run commercial on):
<br /><input type="text" name="tname" id="twitchname" size="20"><br />
Commercial Length (in seconds): 
<br /><input type="text" name="commlen" id="comlen" value="60" size="3"><br />
Auth Token:
<br /><input type="text" name="authtoken" id="token" size="32"><br />

<br />

<p>Current URL (grab Auth Token from here):</p>
<p id="url">Current URL here</p>
<br />
<p id="status">Current Status: None</p>

</body>
</html>
